<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Profile</title>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase.js"></script>

</head>
<body>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDAcVDY54CgLrMsF62GM1UJt79U5YwUKMI",
        authDomain: "case-study-md4.firebaseapp.com",
        projectId: "case-study-md4",
        storageBucket: "case-study-md4.appspot.com",
        messagingSenderId: "1075801629660",
        appId: "1:1075801629660:web:ff596cc3eb33c2f37da519",
        measurementId: "G-VJFQG43GD9"
    };

    firebase.initializeApp(firebaseConfig);
</script>
<div class="container" style="margin-top: 20px;">
    <div class="row flex-lg-nowrap">
        <div class="col-12 col-lg-auto mb-3" style="width: 200px">
            <div class="card p-3">
                <div class="e-navlist e-navlist--active-bg">
                    <ul class="nav">
                        <li class="nav-item"><a class="nav-link px-2 active" href="adminProfile.html" onclick=""><span>Admin Profile</span></a>
                        </li>
                        <li class="nav-item"><a class="nav-link px-2"
                                                href="homeAdmin.html"
                                                ><span>User Management</span></a></li>
                        <li class="nav-item"><a class="nav-link px-2"
                                                href="productManagement.html"
                        ><span>Product Management</span></a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="row">
                <div class="col mb-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="e-profile">
                                <div class="row">
                                    <div class="col-12 col-sm-auto mb-3">
                                        <img class="mx-auto" style="width: 140px; height: 140px; border-radius: 16px"
                                             id="imgDiv" src="">
                                    </div>
                                    <div class="col d-flex flex-column flex-sm-row justify-content-between mb-3">
                                        <div class="text-center text-sm-left mb-2 mb-sm-0">
                                            <h4 class="pt-sm-2 pb-1 mb-0 text-nowrap" id="fullName">John Smith</h4>
                                            <div class="text-muted"><small>Admin</small></div>
                                            <div class="mt-2">
                                                <i class="fa fa-fw fa-camera"></i>
                                                <input type="file" value="upload" accept=".jpg" id="fileButton">
                                            </div>
                                        </div>
                                        <div class="text-center text-sm-right">
                                            <span class="badge badge-secondary">administrator</span>
                                            <div class="text-muted"><small>Joined 09 Dec 2017</small></div>
                                        </div>
                                    </div>
                                </div>
                                <ul class="nav nav-tabs">
                                    <li class="nav-item"><a href="" class="active nav-link">Information</a></li>
                                </ul>
                                <div class="tab-content pt-3">
                                    <div class="tab-pane active">
                                        <div class="row">
                                            <div class="col">
                                                <div class="row">
                                                    <div class="col">
                                                        <div class="form-group">

                                                            <input type="text" id="id" hidden>

                                                            <label>Full Name</label>
                                                            <input class="form-control" type="text" name="name"
                                                                   placeholder="John Smith" value="John Smith"
                                                                   id="name">
                                                        </div>
                                                    </div>
                                                    <div class="col">
                                                        <div class="form-group">
                                                            <label>Username</label>
                                                            <input class="form-control" type="text" name="username"
                                                                   placeholder="johnny.s" value="johnny.s"
                                                                   id="username">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col">
                                                        <div class="form-group">
                                                            <label>Email</label>
                                                            <input class="form-control" type="text"
                                                                   placeholder="user@example.com" id="email">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12 col-sm-6 mb-3">
                                                <div class="row">
                                                    <div class="col">
                                                        <div class="form-group">
                                                            <label>New Password</label>
                                                            <input class="form-control" type="password"
                                                                   placeholder="••••••" id="password">
                                                        </div>
                                                        <span id="status"
                                                              style="color: green; text-align: center"></span>

                                                    </div>
                                                </div>
                                                <!--                                                    <div class="row">-->
                                                <!--                                                        <div class="col">-->
                                                <!--                                                            <div class="form-group">-->
                                                <!--                                                                <label>Confirm <span-->
                                                <!--                                                                        class="d-none d-xl-inline">Password</span></label>-->
                                                <!--                                                                <input class="form-control" type="password"-->
                                                <!--                                                                       placeholder="••••••"></div>-->
                                                <!--                                                        </div>-->
                                                <!--                                                    </div>-->
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col d-flex justify-content-end">
                                                <button class="btn btn-primary" type="submit" id="btn-edit-admin"
                                                        onclick="edit()">
                                                    Save Changes
                                                </button>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-3 mb-3">
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="px-xl-3">
                                <button class="btn btn-block btn-secondary" onclick="logout()">
                                    <i class="fa fa-sign-out"></i>
                                    <span>Logout</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<script type="text/javascript">
    let srcImg;
    var image = '';
    // firebase bucket name
    // REPLACE WITH THE ONE YOU CREATE
    // ALSO CHECK STORAGE RULES IN FIREBASE CONSOLE
    var fbBucketName = 'images';

    // get elements
    var uploader = document.getElementById('uploader');
    var fileButton = document.getElementById('fileButton');

    // listen for file selection
    fileButton.addEventListener('change', function (e) {

        // what happened
        console.log('file upload event', e);

        // get file
        var file = e.target.files[0];

        // create a storage ref
        var storageRef = firebase.storage().ref(`${fbBucketName}/${file.name}`);

        // upload file
        var uploadTask = storageRef.put(file);

        // The part below is largely copy-pasted from the 'Full Example' section from
        // https://firebase.google.com/docs/storage/web/upload-files

        // update progress bar
        uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, // or 'state_changed'
            function (snapshot) {
                // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
                // var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                // uploader.value = progress;
                // console.log('Upload is ' + progress + '% done');
                switch (snapshot.state) {
                    case firebase.storage.TaskState.PAUSED: // or 'paused'
                        console.log('Upload is paused');
                        break;
                    case firebase.storage.TaskState.RUNNING: // or 'running'
                        console.log('Upload is running');
                        break;
                }
            }, function (error) {

                // A full list of error codes is available at
                // https://firebase.google.com/docs/storage/web/handle-errors
                switch (error.code) {
                    case 'storage/unauthorized':
                        // User doesn't have permission to access the object
                        break;

                    case 'storage/canceled':
                        // User canceled the upload
                        break;

                    case 'storage/unknown':
                        // Unknown error occurred, inspect error.serverResponse
                        break;
                }
            }, function () {
                // Upload completed successfully, now we can get the download URL
                // save this link somewhere, e.g. put it in an input field
                var downloadURL = uploadTask.snapshot.downloadURL;
                // image = downloadURL;
                console.log('downloadURL ===>', downloadURL);
                let img = document.getElementById("imgDiv");
                img.src = downloadURL
                srcImg = downloadURL
                console.log('pic ==', downloadURL)
            });

    });


    function getAdmin() {
        let user = JSON.parse(window.sessionStorage.getItem("USER_KEY"));
        console.log(user)
        let name = user.name;
        let username = user.username;
        let email = user.email;
        let id = user.id;
        let img = document.getElementById("imgDiv");
        img.src = user.avatar;


        document.getElementById("name").value = name;
        document.getElementById("fullName").innerText = name;
        document.getElementById("username").value = username;
        document.getElementById("email").value = email;
        document.getElementById("id").value = id;
    }

    getAdmin();


    function edit() {
        let id = document.getElementById("id").value;
        let name = document.getElementById("name").value;
        let avatar = document.getElementById("imgDiv").src;
        let username = document.getElementById("username").value;
        let email = document.getElementById("email").value;
        let password = document.getElementById("password").value;

        let user = {
            'id': id,
            'name': name,
            'avatar': avatar,
            'username': username,
            'email': email,
            'password': password
        }

        $.ajax({
            type: "PUT",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            url: "http://localhost:8080/users/" + id,
            data: JSON.stringify(user),
            //xử lý khi thành công
            success: function (data) {
                window.sessionStorage.removeItem("USER_KEY")
                window.sessionStorage.setItem("USER_KEY", JSON.stringify(data))
                window.location.href = 'adminProfile.html';
                alert("Edit Success!")
            },
            error: function (err) {
                console.log(err)
            }
        })
    }

    function logout() {
        window.sessionStorage.removeItem('TOKEN_KEY')
        window.sessionStorage.removeItem('USER_KEY')

        window.location.href = 'index.html'
    }

</script>
</body>
</html>